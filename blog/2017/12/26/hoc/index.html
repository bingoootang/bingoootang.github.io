<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从 React-Redux connect 看如何编写 HOC（一） | Bingooo.Tang 的日志</title>
    <meta name="description" content="高阶组件,hoc,connect,react-redux">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="preload" href="/assets/css/0.styles.45fd1eb4.css" as="style"><link rel="preload" href="/assets/js/app.1a92a99b.js" as="script"><link rel="preload" href="/assets/js/2.4bb95436.js" as="script"><link rel="preload" href="/assets/js/24.d4db672e.js" as="script"><link rel="preload" href="/assets/js/9.60a9ad14.js" as="script"><link rel="prefetch" href="/assets/js/10.ff19f3cc.js"><link rel="prefetch" href="/assets/js/11.e260adce.js"><link rel="prefetch" href="/assets/js/12.e1d4dc76.js"><link rel="prefetch" href="/assets/js/13.3780b65b.js"><link rel="prefetch" href="/assets/js/14.821eca39.js"><link rel="prefetch" href="/assets/js/15.947a489c.js"><link rel="prefetch" href="/assets/js/16.31117fc6.js"><link rel="prefetch" href="/assets/js/17.aa761a41.js"><link rel="prefetch" href="/assets/js/18.38e91cd9.js"><link rel="prefetch" href="/assets/js/19.2f0ddeb0.js"><link rel="prefetch" href="/assets/js/20.98a05b39.js"><link rel="prefetch" href="/assets/js/21.12bee07e.js"><link rel="prefetch" href="/assets/js/22.825b5c65.js"><link rel="prefetch" href="/assets/js/23.5a7523f8.js"><link rel="prefetch" href="/assets/js/25.9dc639ba.js"><link rel="prefetch" href="/assets/js/26.bb89ef52.js"><link rel="prefetch" href="/assets/js/27.9b952333.js"><link rel="prefetch" href="/assets/js/28.36b12119.js"><link rel="prefetch" href="/assets/js/29.b3fc89ab.js"><link rel="prefetch" href="/assets/js/3.914428ae.js"><link rel="prefetch" href="/assets/js/30.8403f552.js"><link rel="prefetch" href="/assets/js/31.3a71fc7c.js"><link rel="prefetch" href="/assets/js/32.f63547d0.js"><link rel="prefetch" href="/assets/js/33.30c37fb4.js"><link rel="prefetch" href="/assets/js/34.b1e97f3f.js"><link rel="prefetch" href="/assets/js/35.ab2a7a8c.js"><link rel="prefetch" href="/assets/js/36.5d422d5b.js"><link rel="prefetch" href="/assets/js/37.839e7d79.js"><link rel="prefetch" href="/assets/js/38.72e8bf2f.js"><link rel="prefetch" href="/assets/js/39.9a05368b.js"><link rel="prefetch" href="/assets/js/4.5c559b86.js"><link rel="prefetch" href="/assets/js/40.a8400673.js"><link rel="prefetch" href="/assets/js/41.ead2592b.js"><link rel="prefetch" href="/assets/js/42.2b99ba39.js"><link rel="prefetch" href="/assets/js/43.340f4287.js"><link rel="prefetch" href="/assets/js/44.6bf6391c.js"><link rel="prefetch" href="/assets/js/45.c33e2690.js"><link rel="prefetch" href="/assets/js/46.acfb4c4c.js"><link rel="prefetch" href="/assets/js/47.0d284677.js"><link rel="prefetch" href="/assets/js/48.7e5faf9d.js"><link rel="prefetch" href="/assets/js/49.70243ee5.js"><link rel="prefetch" href="/assets/js/5.4f064dd5.js"><link rel="prefetch" href="/assets/js/50.a70d1e3a.js"><link rel="prefetch" href="/assets/js/51.54705e9f.js"><link rel="prefetch" href="/assets/js/52.5e8b3d7e.js"><link rel="prefetch" href="/assets/js/53.03656bc8.js"><link rel="prefetch" href="/assets/js/54.d3b3024e.js"><link rel="prefetch" href="/assets/js/55.b8b66fcf.js"><link rel="prefetch" href="/assets/js/56.bcc27a01.js"><link rel="prefetch" href="/assets/js/57.dd12e611.js"><link rel="prefetch" href="/assets/js/6.8113e0b5.js"><link rel="prefetch" href="/assets/js/7.222800b2.js"><link rel="prefetch" href="/assets/js/8.84f16d44.js">
    <link rel="stylesheet" href="/assets/css/0.styles.45fd1eb4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Bingooo.Tang 的日志</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link">教程</a></div><div class="nav-item"><a href="/tools/" class="nav-link">工具</a></div> <a href="https://github.com/bingoootang" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link">教程</a></div><div class="nav-item"><a href="/tools/" class="nav-link">工具</a></div> <a href="https://github.com/bingoootang" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="content default"><h1 id="从-react-redux-connect-看如何编写-hoc（一）"><a href="#从-react-redux-connect-看如何编写-hoc（一）" aria-hidden="true" class="header-anchor">#</a> 从 React-Redux connect 看如何编写 HOC（一）</h1> <p>HOC（Higher-Order Component），中文译作高阶组件，是基于 React 的原生组合特性提炼出来的组件复用模式。准确的说，一个高阶组件就是一个接受一个组件作为参数并返回一个新的组件的函数。其形式类似于下面这段代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> EnhancedComponent <span class="token operator">=</span> <span class="token function">higherOrderComponent</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们知道，在 React 中，组件是最基本的复用单元。但是在开发过程中，我们经常发现，两个不同的组件通常会有极其相似的结构，仅仅只是调用的接口不同。比如，页面中的两个组件分别监听两个事件，并在接收到事件时去服务端拉取数据。在开发这两个的时候，我们需要在组件中分别写一段相同的添加事件监听、删除事件监听、去服务端拉取数据等代码逻辑。如果其他页面也有相似的结构，但是监听事件和调用接口都不一样，我们就需要再次实现同样结构的组件。这其实是一种没有意义的重复，热爱思考的程序员是不愿意干这种纯体力劳动的，所以有了高阶组件。我们把添加、删除事件监听，拉取数据等逻辑放到高阶组件中，而真实的组件只需要接收数据并完成渲染就可以了。</p> <blockquote><p>上面这个问题，在软件工程中有个专有的名词，叫横切关注点（<a href="https://en.wikipedia.org/wiki/Cross-cutting_concern" target="_blank" rel="noopener noreferrer">Cross-Cutting Concerns<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），高阶组件是我们在 React 应用开发过程中解决这个问题的一个很好的模式。</p></blockquote> <p>任何一个模式都不是万能的，高阶组件也有一些使用约束。</p> <p>高阶组件不提倡以下做法：</p> <ol><li>在高阶组件中修改原始组件，比如修改了生命周期方法。<br>
首先，如果修改了原始组件，会导致原始组件不能单独复用。其次，如果一个组件被多个高阶组件使用，可能会造成复写，比如同时修改了生命周期方法。</li> <li>在组件的 render 方法中使用高阶组件。
React 会判断两次 render 返回的实例是否相同，如果相同则会递归执行 React Diff 算法来更新实例，如果不同，则直接将就得实例 unmount 掉。如果在 render 方法中使用高阶组件，不仅会造成可能的性能问题，还会造成所有子组件状态的丢失。</li></ol> <p>高阶组件提倡以下做法：</p> <ol><li>将与高阶组件的实现不相关的 props 传递给被包装的组件。<br>
这样的话，在使用高阶组件的时候就和使用原始组件是一样的，使用者对于高级组件的存在是无感的。</li> <li>最大限度的使用组合。
我们在开发高阶组件的时候，通常都需要额外的支持一些配置参数，这时，高阶组件的形式可能是：</li></ol> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> CommentWithRelay <span class="token operator">=</span> Relay<span class="token punctuation">.</span><span class="token function">createContainer</span><span class="token punctuation">(</span>Comment<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Relay.createContainer 是一个高阶组件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时如果我们需要组合使用多个高阶组件时，我们就需要多次调用类似于上面的逻辑。社区有很多类似于 <a href="https://redux.js.org/docs/api/compose.html" target="_blank" rel="noopener noreferrer">Redux Compose<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的方法来帮我们做这些事情，但是这些方法的签名都是类似于 <code>Component =&gt; Component</code> 的方式，所以，我们的高阶组件的定义方式建议定义成</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ConnectedComment <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>commentSelector<span class="token punctuation">,</span> commentActions<span class="token punctuation">)</span><span class="token punctuation">(</span>CommentList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>而这也正是 React-Redux 中 connect 方法的签名。<br>
这样的话，我们就可以轻松的通过 compose 工具函数完成多个高阶组件的组合了。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Instead of doing this...</span>
<span class="token keyword">const</span> EnhancedComponent <span class="token operator">=</span> <span class="token function">withRouter</span><span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>commentSelector<span class="token punctuation">)</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// ... you can use a function composition utility</span>
<span class="token comment">// compose(f, g, h) is the same as (...args) =&gt; f(g(h(...args)))</span>
<span class="token keyword">const</span> enhance <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  <span class="token comment">// These are both single-argument HOCs</span>
  withRouter<span class="token punctuation">,</span>
  <span class="token function">connect</span><span class="token punctuation">(</span>commentSelector<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> EnhancedComponent <span class="token operator">=</span> <span class="token function">enhance</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="3"><li>给高阶组件添加 <code>displayName</code> 属性<br>
添加 <code>displayName</code> 属性后，通过 <a href="https://github.com/facebook/react-devtools" target="_blank" rel="noopener noreferrer">react-devtools<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 等调试工具调试时就可以清楚的看到组件名，提升调试效率。</li> <li>组件静态方法必须要拷贝到高阶组件中。<br>
保持组件接口的一致性。</li></ol> <p>除了以上提到的以外，在使用高阶组件的时候，我们还需要注意，高阶组件不会将 <code>refs</code> 传递给被包装的组件。如果要实现在高阶组件中能拿到被包装组建的 refs，则可以在高阶组件中实现被包装组件的 refs 绑定函数，并将它通过 props 传递给被包装的组件。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">5/13/2019, 3:05:16 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.1a92a99b.js" defer></script><script src="/assets/js/2.4bb95436.js" defer></script><script src="/assets/js/24.d4db672e.js" defer></script><script src="/assets/js/9.60a9ad14.js" defer></script>
  </body>
</html>
