<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从 React-Redux connect 看如何编写 HOC（二） | Bingooo.Tang 的日志</title>
    <meta name="description" content="高阶组件,hoc,connect,react-redux">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="preload" href="/assets/css/0.styles.45fd1eb4.css" as="style"><link rel="preload" href="/assets/js/app.1a92a99b.js" as="script"><link rel="preload" href="/assets/js/2.4bb95436.js" as="script"><link rel="preload" href="/assets/js/25.9dc639ba.js" as="script"><link rel="preload" href="/assets/js/9.60a9ad14.js" as="script"><link rel="prefetch" href="/assets/js/10.ff19f3cc.js"><link rel="prefetch" href="/assets/js/11.e260adce.js"><link rel="prefetch" href="/assets/js/12.e1d4dc76.js"><link rel="prefetch" href="/assets/js/13.3780b65b.js"><link rel="prefetch" href="/assets/js/14.821eca39.js"><link rel="prefetch" href="/assets/js/15.947a489c.js"><link rel="prefetch" href="/assets/js/16.31117fc6.js"><link rel="prefetch" href="/assets/js/17.aa761a41.js"><link rel="prefetch" href="/assets/js/18.38e91cd9.js"><link rel="prefetch" href="/assets/js/19.2f0ddeb0.js"><link rel="prefetch" href="/assets/js/20.98a05b39.js"><link rel="prefetch" href="/assets/js/21.12bee07e.js"><link rel="prefetch" href="/assets/js/22.825b5c65.js"><link rel="prefetch" href="/assets/js/23.5a7523f8.js"><link rel="prefetch" href="/assets/js/24.d4db672e.js"><link rel="prefetch" href="/assets/js/26.bb89ef52.js"><link rel="prefetch" href="/assets/js/27.9b952333.js"><link rel="prefetch" href="/assets/js/28.36b12119.js"><link rel="prefetch" href="/assets/js/29.b3fc89ab.js"><link rel="prefetch" href="/assets/js/3.914428ae.js"><link rel="prefetch" href="/assets/js/30.8403f552.js"><link rel="prefetch" href="/assets/js/31.3a71fc7c.js"><link rel="prefetch" href="/assets/js/32.f63547d0.js"><link rel="prefetch" href="/assets/js/33.30c37fb4.js"><link rel="prefetch" href="/assets/js/34.b1e97f3f.js"><link rel="prefetch" href="/assets/js/35.ab2a7a8c.js"><link rel="prefetch" href="/assets/js/36.5d422d5b.js"><link rel="prefetch" href="/assets/js/37.839e7d79.js"><link rel="prefetch" href="/assets/js/38.72e8bf2f.js"><link rel="prefetch" href="/assets/js/39.9a05368b.js"><link rel="prefetch" href="/assets/js/4.5c559b86.js"><link rel="prefetch" href="/assets/js/40.a8400673.js"><link rel="prefetch" href="/assets/js/41.ead2592b.js"><link rel="prefetch" href="/assets/js/42.2b99ba39.js"><link rel="prefetch" href="/assets/js/43.340f4287.js"><link rel="prefetch" href="/assets/js/44.6bf6391c.js"><link rel="prefetch" href="/assets/js/45.c33e2690.js"><link rel="prefetch" href="/assets/js/46.acfb4c4c.js"><link rel="prefetch" href="/assets/js/47.0d284677.js"><link rel="prefetch" href="/assets/js/48.7e5faf9d.js"><link rel="prefetch" href="/assets/js/49.70243ee5.js"><link rel="prefetch" href="/assets/js/5.4f064dd5.js"><link rel="prefetch" href="/assets/js/50.a70d1e3a.js"><link rel="prefetch" href="/assets/js/51.54705e9f.js"><link rel="prefetch" href="/assets/js/52.5e8b3d7e.js"><link rel="prefetch" href="/assets/js/53.03656bc8.js"><link rel="prefetch" href="/assets/js/54.d3b3024e.js"><link rel="prefetch" href="/assets/js/55.b8b66fcf.js"><link rel="prefetch" href="/assets/js/56.bcc27a01.js"><link rel="prefetch" href="/assets/js/57.dd12e611.js"><link rel="prefetch" href="/assets/js/6.8113e0b5.js"><link rel="prefetch" href="/assets/js/7.222800b2.js"><link rel="prefetch" href="/assets/js/8.84f16d44.js">
    <link rel="stylesheet" href="/assets/css/0.styles.45fd1eb4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Bingooo.Tang 的日志</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link">教程</a></div><div class="nav-item"><a href="/tools/" class="nav-link">工具</a></div> <a href="https://github.com/bingoootang" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link">教程</a></div><div class="nav-item"><a href="/tools/" class="nav-link">工具</a></div> <a href="https://github.com/bingoootang" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="content default"><h1 id="从-react-redux-connect-看如何编写-hoc（二）"><a href="#从-react-redux-connect-看如何编写-hoc（二）" aria-hidden="true" class="header-anchor">#</a> 从 React-Redux connect 看如何编写 HOC（二）</h1> <p>熟悉 Redux 和 React 的同学必然使用过 <a href="https://github.com/reactjs/react-redux/" target="_blank" rel="noopener noreferrer">React-Redux<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这个库实现了从 Redux 到 React 的绑定，并提供了精简的 API 供开发者使用。本文就是从 <a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#connectmapstatetoprops-mapdispatchtoprops-mergeprops-options" target="_blank" rel="noopener noreferrer">connect<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 方法源码来分析如何编写高阶组件。</p> <p><code>connect</code> 方法的函数签名是: <code>connect([mapStateToProps], [mapDispatchToProps], [mergeProps], [options])(Component) =&gt; EnhancedComponent</code>。这正是前文中高阶组件的标准写法。</p> <p><a href="https://github.com/reactjs/react-redux/blob/master/src/connect/connect.js" target="_blank" rel="noopener noreferrer"><code>connect</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 其实是 <a href="https://github.com/reactjs/react-redux/blob/master/src/components/connectAdvanced.js" target="_blank" rel="noopener noreferrer"><code>connectAdvanced</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的包装，在设计模式中叫<a href="https://en.wikipedia.org/wiki/Facade_pattern" target="_blank" rel="noopener noreferrer">外观（facade）模式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。所有 <code>connectAdvanced</code> 才是核心的组件，我们先通过分析 <code>connectAdvanced</code> 来看 HOC 的写法。</p> <p><code>connectAdvanced</code> 与 <code>connect</code> 有着相似的签名，<code>connectAdvanced(selectorFactory, options)(Component) =&gt; EnhancedComponent</code>，它本身是一个高阶函数，返回一个函数，这个返回的函数根据高阶函数的定义就是高阶组件。通过精简，<code>connectAdvanced</code> 的代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">connectAdvanced</span><span class="token punctuation">(</span>
  <span class="token parameter">selectorFactory<span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token operator">...</span>defaultOptions
    <span class="token operator">...</span>connectOptions
  <span class="token punctuation">}</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">wrapWithConnect</span><span class="token punctuation">(</span><span class="token parameter">WrappedComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Connect</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
      <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>store <span class="token operator">=</span> props<span class="token punctuation">[</span>storeKey<span class="token punctuation">]</span> <span class="token operator">||</span> context<span class="token punctuation">[</span>storeKey<span class="token punctuation">]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subscription<span class="token punctuation">.</span><span class="token function">trySubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span>shouldComponentUpdate<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">initSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> sourceSelector <span class="token operator">=</span> <span class="token function">selectorFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span> selectorFactoryOptions<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>selector <span class="token operator">=</span> <span class="token function">makeSelectorStateful</span><span class="token punctuation">(</span>sourceSelector<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">initSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> parentSub <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>propsMode <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">[</span>subscriptionKey<span class="token punctuation">]</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subscription <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subscription</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">,</span> parentSub<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStateChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notifyNestedSubs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subscription<span class="token punctuation">.</span><span class="token function">notifyNestedSubs</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subscription<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">onStateChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span>shouldComponentUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyNestedSubs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>componentDidUpdate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>notifyNestedSubsOnComponentDidUpdate
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>dummyState<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> selector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector
        selector<span class="token punctuation">.</span>shouldComponentUpdate <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selector<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> selector<span class="token punctuation">.</span>error
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addExtraProps</span><span class="token punctuation">(</span>selector<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    Connect<span class="token punctuation">.</span>displayName <span class="token operator">=</span> displayName
    <span class="token keyword">return</span> <span class="token function">hoistStatics</span><span class="token punctuation">(</span>Connect<span class="token punctuation">,</span> WrappedComponent<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>我们看到，在 <code>wrapWithConnect</code> 返回组件的构造函数中，有两个函数调用，<code>initSelector</code> 和 <code>initSubscription</code>。先看 <code>initSubscription</code>，在其函数体内创建了一个 <code>Subscription</code> 对象，这个对象提供了 <code>trySubscribe</code> 方法。上面组件在 <code>componentDidMount</code> 方法中也调用了 <code>trySubscribe</code>。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">trySubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>unsubscribe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>unsubscribe <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parentSub
      <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parentSub<span class="token punctuation">.</span><span class="token function">addNestedSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>onStateChange<span class="token punctuation">)</span>
      <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>onStateChange<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listeners <span class="token operator">=</span> <span class="token function">createListenerCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>我们看到，通过 <code>this.store.subscribe</code>，我们将上面组件的 <code>onStateChange</code> 方法注册到了 Redux 的 store 中，此后，store 的更新将会通知到组件，完成了 Redux 到 React 组件的初步绑定。<br>
在组件的 <code>onStateChange</code> 方法中，会运行 <code>initSelector</code> 方法返回的 selector。这里需要简单说明下 selector 的概念。selector，是一个针对应用状态（store.getState()）的选择器，通过 selector 我们可以从应用状态中选择出组件需要的字段。关于 selector 的更多信息及使用方式，可以参考常和 Redux 配套使用的 <a href="https://github.com/reactjs/reselect" target="_blank" rel="noopener noreferrer">reselect<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。在 <code>initSelector</code> 方法中，调用了传入的 <code>selectorFactory</code> 工厂方法，构建出一个选择器，并通过 <code>makeSelectorStateful</code> 方法</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">makeSelectorStateful</span><span class="token punctuation">(</span><span class="token parameter">sourceSelector<span class="token punctuation">,</span> store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> selector <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">run</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">runComponentSelector</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> nextProps <span class="token operator">=</span> <span class="token function">sourceSelector</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps <span class="token operator">!==</span> selector<span class="token punctuation">.</span>props <span class="token operator">||</span> selector<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          selector<span class="token punctuation">.</span>shouldComponentUpdate <span class="token operator">=</span> <span class="token boolean">true</span>
          selector<span class="token punctuation">.</span>props <span class="token operator">=</span> nextProps
          selector<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        selector<span class="token punctuation">.</span>shouldComponentUpdate <span class="token operator">=</span> <span class="token boolean">true</span>
        selector<span class="token punctuation">.</span>error <span class="token operator">=</span> error
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> selector
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>包装了这个选择器，以跟踪多次运行的结果。<br>
在组件的 <code>onStateChange</code> 方法中，运行包装后的选择器，传入组件的 props 得到组件最新的 props，并根据比较，决定是否更新组件。在组件的 <code>render</code> 方法中，也正是从这个选择器是上获取最新的 props，渲染组件。</p> <p>以上，我们分析了这个高阶组件的具体功能，分析了如何从 Redux store 的更新到组件的更新，我们看到，新返回的组件的接口与原始组件的接口完全一致，任何传递给新组件的 props 都将会传递给原始的组件，当然，传递给原始组件的 props 是通过选择器选择后的。有人会问这样会不会导致两个传给新组件的 props 和传给原始组件的 Props 不同呢？这是有可能的，但是这种变化由用户决定，即用户可以定制选择器。这当中的细节，就需要看 <code>selectorFactory</code> 的生成过程。我们先按住不表，继续高阶组件的话题。</p> <p>在上篇文章中，我们说过，要想保证新组件和原始组件接口完全一致，还需要在高阶组件中复制原始组件的静态方法。对于一个通用的高阶组件来说，我们如何知道应该复制原始组件的哪些静态方法呢？从上面高阶组件的代码中，我们看到，最后返回语句是</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">return</span> <span class="token function">hoistStatics</span><span class="token punctuation">(</span>Connect<span class="token punctuation">,</span> WrappedComponent<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>而 <code>hoistStatics</code> 就是 <a href="https://github.com/mridgway/hoist-non-react-statics" target="_blank" rel="noopener noreferrer">hoist-non-react-statics<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，一个专门拷贝 React 组件静态方法的库。这个库类似于 <code>Object.assign</code>，但是会保留 React 组件本身定义的方法不会被拷贝。<br>
到这里，我们从 <code>connectAdvanced</code> 函数中看到了高阶组件的具体写法，顺便也学习了一下 <code>React-Redux connectAdvanced</code> 的源代码，一举两得。然而，本文到此并没有结束，前面丢了个问题还没有说明，那就是 <code>selectorFactory</code> 的生成过程。既然都看了源代码，索性就多看一点，看看还有什么黑科技。</p> <p>前文说到，<code>connect</code> 是 <code>connectAdvanced</code> 的一个外观模式的实现，它给开发者提供了更加易于创建 <code>selectorFactory</code> 的 API。在 <code>connect</code> 代码中，默认导出 <code>createConenct</code> 函数的调用结果，而 <code>createConnect</code> 的结构如下（同样经过精简）：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createConnect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  connectHOC <span class="token operator">=</span> connectAdvanced<span class="token punctuation">,</span>
  mapStateToPropsFactories <span class="token operator">=</span> defaultMapStateToPropsFactories<span class="token punctuation">,</span>
  mapDispatchToPropsFactories <span class="token operator">=</span> defaultMapDispatchToPropsFactories<span class="token punctuation">,</span>
  mergePropsFactories <span class="token operator">=</span> defaultMergePropsFactories<span class="token punctuation">,</span>
  selectorFactory <span class="token operator">=</span> defaultSelectorFactory
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">connect</span><span class="token punctuation">(</span>
    <span class="token parameter">mapStateToProps<span class="token punctuation">,</span>
    mapDispatchToProps<span class="token punctuation">,</span>
    mergeProps<span class="token punctuation">,</span>
    options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> initMapStateToProps <span class="token operator">=</span> <span class="token function">match</span><span class="token punctuation">(</span>mapStateToProps<span class="token punctuation">,</span> mapStateToPropsFactories<span class="token punctuation">,</span> <span class="token string">'mapStateToProps'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> initMapDispatchToProps <span class="token operator">=</span> <span class="token function">match</span><span class="token punctuation">(</span>mapDispatchToProps<span class="token punctuation">,</span> mapDispatchToPropsFactories<span class="token punctuation">,</span> <span class="token string">'mapDispatchToProps'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> initMergeProps <span class="token operator">=</span> <span class="token function">match</span><span class="token punctuation">(</span>mergeProps<span class="token punctuation">,</span> mergePropsFactories<span class="token punctuation">,</span> <span class="token string">'mergeProps'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">connectHOC</span><span class="token punctuation">(</span>selectorFactory<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      methodName<span class="token punctuation">:</span> <span class="token string">'connect'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">getDisplayName</span><span class="token punctuation">:</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token string">`Connect(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)`</span></span><span class="token punctuation">,</span>
      shouldHandleStateChanges<span class="token punctuation">:</span> <span class="token function">Boolean</span><span class="token punctuation">(</span>mapStateToProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// passed through to selectorFactory</span>
      initMapStateToProps<span class="token punctuation">,</span>
      initMapDispatchToProps<span class="token punctuation">,</span>
      initMergeProps<span class="token punctuation">,</span>
      <span class="token operator">...</span>options
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>也就是说，我们平时使用的 connect 方法，其实是 <code>createConnect</code> 函数无参调用的结果。在高阶函数 <code>createConnect</code> 返回的 <code>connect</code> 函数中，我们看到了 <code>selectorFactory</code>，无参调用情况下，就是 <code>defaultSelectorFactory</code>。我们先不急着看 <code>defaultSelectorFactory</code> 的实现，先看下在 connect API 中提供给我们的三个参数，<code>mapStateToProps</code>， <code>mapDispatchToProps</code> 和 <code>mergeProps</code>。由于这三个实现相似，我们选取 <code>mapStateToProps</code> 作为分析样本。<br>
从上面的代码中我们看到，开发者传入的 <code>mapStateToProps</code> 会经过 <code>match</code> 函数的处理，而 <code>match</code> 函数的职责正是在众多的工厂函数中匹配一个合适的工厂函数，用于创建可供选择器调用的 mapStateToProps。在 <code>defaultSelectorFactory</code> 中，定义了多个工厂函数，用于处理开发者传入的不同类型的 <code>mapStateToProps</code>。这些工厂函数都会统一返回一个签名为 <code>(dispatch, options) =&gt; (stateOrDispatch, ownProps) =&gt; props</code> 函数，就是上面的 <code>initMapStateToProps</code>。
在 <code>connect</code> 中返回了前面分析的高阶组件 <code>connectAdvanced</code>，并将 <code>defaultSelectorFactory</code> 和匹配到的 <code>initMapStateToProps</code> 作为参数传递给 <code>connectAdvanced</code>。在 <code>connectAdvanced</code> 代码中我们已经看到，<code>initMapStateToProps</code> 又会被传递给 <code>defaultSelectorFactory</code>。我们现在分析下 <code>defaultSelectorFactory</code> 的实现。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">finalPropsSelectorFactory</span><span class="token punctuation">(</span><span class="token parameter">dispatch<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  initMapStateToProps<span class="token punctuation">,</span>
  initMapDispatchToProps<span class="token punctuation">,</span>
  initMergeProps<span class="token punctuation">,</span>
  <span class="token operator">...</span>options
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mapStateToProps <span class="token operator">=</span> <span class="token function">initMapStateToProps</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token keyword">const</span> selectorFactory <span class="token operator">=</span> options<span class="token punctuation">.</span>pure
    <span class="token operator">?</span> pureFinalPropsSelectorFactory
    <span class="token punctuation">:</span> impureFinalPropsSelectorFactory
  <span class="token keyword">return</span> <span class="token function">selectorFactory</span><span class="token punctuation">(</span>
    mapStateToProps<span class="token punctuation">,</span>
    mapDispatchToProps<span class="token punctuation">,</span>
    mergeProps<span class="token punctuation">,</span>
    dispatch<span class="token punctuation">,</span>
    options
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>finalPropsSelectorFactory</code> 即 <code>defaultSelectorFactory</code>接受一个 dispatch 参数，和一个对象参数，这与上面 <code>connectAdvanced</code> 中 <code>initSelector</code> 的调用方式相符。在这个函数中，会将 disaptch 和对象参数传递给 <code>initMapStateToProps</code> 并得到签名为 <code>(stateOrDispatch, ownProps) =&gt; props</code> 的 <code>mapStateToProps</code>，这就跟我们开发者传入的函数签名一致了。最后，<code>finalPropsSelectorFactory</code> 返回 <code>selectorFactory</code> 工厂函数返回的调用结果。从前面 <code>connectAdvanced</code> 的代码中可以看到，这个工厂函数返回的结果函数签名应该是 <code>(state, props) =&gt; newProps</code>。简单起见，我们看下 <code>impureFinalPropsSelectorFactory</code> 的实现。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">impureFinalPropsSelectorFactory</span><span class="token punctuation">(</span>
  <span class="token parameter">mapStateToProps<span class="token punctuation">,</span>
  mapDispatchToProps<span class="token punctuation">,</span>
  mergeProps<span class="token punctuation">,</span>
  dispatch</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">impureFinalPropsSelector</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> ownProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">mergeProps</span><span class="token punctuation">(</span>
      <span class="token function">mapStateToProps</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> ownProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">mapDispatchToProps</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> ownProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
      ownProps
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我们看到，<code>impureFinalPropsSelectorFactory</code> 工厂函数返回的函数签名与我们在 <code>connectAdvanced</code> 看到的一致，高阶组件 <code>connectAdvanced</code> 将 Redux <code>store.getState()</code> 和自身的 props 传递给选择器，选择器返回最新的 props。而选择器的内部逻辑就是我们自己定义的 <code>mapStateToProps</code>，<code>mapDispatchToProps</code> 和  <code>mergeProps</code> 的实现逻辑。<br>
至此，选择器的生成过程我们也分析了一遍。</p> <p>最后，本文通过分析 <code>connectAdvanced</code> 的代码，分析了 HOC 的编写方法，虽然本文标题为《从 React-Redux connect 来看如何编写 HOC》，但是也顺带分析了 <code>connect</code> 函数的逻辑，了解了选择器的生成过程，在此过程中了解了工厂模式和外观模式这两种设计模式。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">5/13/2019, 3:05:16 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.1a92a99b.js" defer></script><script src="/assets/js/2.4bb95436.js" defer></script><script src="/assets/js/25.9dc639ba.js" defer></script><script src="/assets/js/9.60a9ad14.js" defer></script>
  </body>
</html>
