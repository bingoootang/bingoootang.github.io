<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Docker 构建镜像过程中 npm 安装 私有 git repo | Bingooo.Tang 的日志</title>
    <meta name="description" content="npm install private git repo in docker build">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="preload" href="/assets/css/0.styles.45fd1eb4.css" as="style"><link rel="preload" href="/assets/js/app.1a92a99b.js" as="script"><link rel="preload" href="/assets/js/2.4bb95436.js" as="script"><link rel="preload" href="/assets/js/27.9b952333.js" as="script"><link rel="preload" href="/assets/js/9.60a9ad14.js" as="script"><link rel="prefetch" href="/assets/js/10.ff19f3cc.js"><link rel="prefetch" href="/assets/js/11.e260adce.js"><link rel="prefetch" href="/assets/js/12.e1d4dc76.js"><link rel="prefetch" href="/assets/js/13.3780b65b.js"><link rel="prefetch" href="/assets/js/14.821eca39.js"><link rel="prefetch" href="/assets/js/15.947a489c.js"><link rel="prefetch" href="/assets/js/16.31117fc6.js"><link rel="prefetch" href="/assets/js/17.aa761a41.js"><link rel="prefetch" href="/assets/js/18.38e91cd9.js"><link rel="prefetch" href="/assets/js/19.2f0ddeb0.js"><link rel="prefetch" href="/assets/js/20.98a05b39.js"><link rel="prefetch" href="/assets/js/21.12bee07e.js"><link rel="prefetch" href="/assets/js/22.825b5c65.js"><link rel="prefetch" href="/assets/js/23.5a7523f8.js"><link rel="prefetch" href="/assets/js/24.d4db672e.js"><link rel="prefetch" href="/assets/js/25.9dc639ba.js"><link rel="prefetch" href="/assets/js/26.bb89ef52.js"><link rel="prefetch" href="/assets/js/28.36b12119.js"><link rel="prefetch" href="/assets/js/29.b3fc89ab.js"><link rel="prefetch" href="/assets/js/3.914428ae.js"><link rel="prefetch" href="/assets/js/30.8403f552.js"><link rel="prefetch" href="/assets/js/31.3a71fc7c.js"><link rel="prefetch" href="/assets/js/32.f63547d0.js"><link rel="prefetch" href="/assets/js/33.30c37fb4.js"><link rel="prefetch" href="/assets/js/34.b1e97f3f.js"><link rel="prefetch" href="/assets/js/35.ab2a7a8c.js"><link rel="prefetch" href="/assets/js/36.5d422d5b.js"><link rel="prefetch" href="/assets/js/37.839e7d79.js"><link rel="prefetch" href="/assets/js/38.72e8bf2f.js"><link rel="prefetch" href="/assets/js/39.9a05368b.js"><link rel="prefetch" href="/assets/js/4.5c559b86.js"><link rel="prefetch" href="/assets/js/40.a8400673.js"><link rel="prefetch" href="/assets/js/41.ead2592b.js"><link rel="prefetch" href="/assets/js/42.2b99ba39.js"><link rel="prefetch" href="/assets/js/43.340f4287.js"><link rel="prefetch" href="/assets/js/44.6bf6391c.js"><link rel="prefetch" href="/assets/js/45.c33e2690.js"><link rel="prefetch" href="/assets/js/46.acfb4c4c.js"><link rel="prefetch" href="/assets/js/47.0d284677.js"><link rel="prefetch" href="/assets/js/48.7e5faf9d.js"><link rel="prefetch" href="/assets/js/49.70243ee5.js"><link rel="prefetch" href="/assets/js/5.4f064dd5.js"><link rel="prefetch" href="/assets/js/50.a70d1e3a.js"><link rel="prefetch" href="/assets/js/51.54705e9f.js"><link rel="prefetch" href="/assets/js/52.5e8b3d7e.js"><link rel="prefetch" href="/assets/js/53.03656bc8.js"><link rel="prefetch" href="/assets/js/54.d3b3024e.js"><link rel="prefetch" href="/assets/js/55.b8b66fcf.js"><link rel="prefetch" href="/assets/js/56.bcc27a01.js"><link rel="prefetch" href="/assets/js/57.dd12e611.js"><link rel="prefetch" href="/assets/js/6.8113e0b5.js"><link rel="prefetch" href="/assets/js/7.222800b2.js"><link rel="prefetch" href="/assets/js/8.84f16d44.js">
    <link rel="stylesheet" href="/assets/css/0.styles.45fd1eb4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Bingooo.Tang 的日志</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link">教程</a></div><div class="nav-item"><a href="/tools/" class="nav-link">工具</a></div> <a href="https://github.com/bingoootang" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link">教程</a></div><div class="nav-item"><a href="/tools/" class="nav-link">工具</a></div> <a href="https://github.com/bingoootang" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="content default"><h1 id="docker-构建镜像过程中-npm-安装-私有-git-repo"><a href="#docker-构建镜像过程中-npm-安装-私有-git-repo" aria-hidden="true" class="header-anchor">#</a> Docker 构建镜像过程中 npm 安装 私有 git repo</h1> <p>Docker 已是主流的虚拟化技术，越来越多的应用都通过 Docker 来构建镜像和部署。目前，团队的所有 Node 应用都已经 Docker 化。在这个过程中，我们碰到了一个问题，就是在构建镜像的时候，通过 <code>npm install</code> 安装 github 私有仓库依赖，总是会报下面的错误：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm ERR! Error while executing:
npm ERR! /usr/bin/git ls-remote -h -t ssh://git@github.com/&lt;git-user&gt;/&lt;repo-name&gt;.git
npm ERR!
npm ERR! Host key verification failed.
npm ERR! fatal: Could not read from remote repository.
npm ERR!
npm ERR! Please make sure you have the correct access rights
npm ERR! and the repository exists.
npm ERR!
npm ERR! exited with error code: 128

npm ERR! A complete log of this run can be found in:
npm ERR!     /root/.npm/_logs/2018-02-09T06_19_57_405Z-debug.log
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>从错误日志可以看出，由于 git 使用 ssh 协议来安装依赖，提示 host key 认证失败，没有权限。不难想到，在构建过程中，ssh 在用户的 home 目录下没有找到正确的 ssh_key（~/.ssh/id_rsa)，导致认证失败。</p> <p>那么，如何解决这个问题呢？首先，观察下 <code>package.json</code> 中的依赖安装方式：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;somepkg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;github:&lt;git-user&gt;/&lt;repo-name&gt;&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这是 npm 提供的一种安装依赖的方式，即从 github 仓库中安装依赖。当采用这个方式安装依赖的时候，npm 会使用 git 将目标依赖的仓库代码 clone 下来，在 clone 的时候，如何依赖中没有指定协议，npm 会默认使用 git+ssh  的方式来访问 github 。如果失败，就出现了开头的那个错误并退出安装。</p> <p>了解了原因之后，我们就可以寻找针对性的解决办法了。既然是 ssh 连接失败，那么我们是不是可以模拟我们本地安装的时候的环境呢？即在镜像构建过程中，建一个 .ssh 目录，将事先准备好的 ssh_key 放进去呢？<br>
说干就干，在 <code>Dockerfile</code> 中我们加入了如下命令：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>RUN <span class="token function">mkdir</span> ~/.ssh
COPY /mysshkey ~/.ssh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>启动构建之后依然报错。通过排查发现，ssh 还是没有使用我们提供 ssh_key，~ 目录下也没有 .ssh 目录。查询资料发现，这可能跟 Docker 分层构建有关，由于没有细究这个问题，这里不详细说明。</p> <p>既然简单粗暴的方式不行，那我们就找一个更简单粗暴的方式。<br>
通过查询 <code>npm install</code> 的文档发现，npm 在通过 <code>npm install &lt;git remote url&gt;</code> 方式安装依赖的时候，支持通过 <code>GIT_SSH</code> 环境变量传入一个脚本给 git，进而 git 会使用我们指定的脚本而不是默认的 ssh 来 clone 仓库。因此，替换刚才的命令为，</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ENV GIT_SSH<span class="token operator">=</span><span class="token string">&quot;/node-image/custom-ssh.sh&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中 <code>/node-image/custom-ssh.sh</code> 就是我们的自定义脚本，内容如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#!/usr/bin/env bash</span>
<span class="token function">ssh</span> -i /node-image/.ssh/id_rsa \
  -o UserKnownHostsFile<span class="token operator">=</span>/dev/null \
  -o StrictHostKeyChecking<span class="token operator">=</span>no \
  <span class="token variable">$*</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>不难看出，这个 <code>custom-ssh.sh</code> 会让 ssh 使用我们预先准备好的 <code>/node-image/.ssh/id_rsa</code> 来访问 github，这样就可以顺利安装私有仓库的依赖了。</p> <p>完整的 <code>Dockerfile</code> 样例如下：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>FROM node:8

<span class="token comment"># Set the working directory to /app</span>
WORKDIR /node-image

<span class="token comment"># Copy the current directory contents into the container at /app</span>
ADD <span class="token keyword">.</span> /node-image

<span class="token comment"># change permission</span>
RUN <span class="token function">chmod</span> 400 /node-image/.ssh/id_rsa

<span class="token comment"># add executable permission to ssh.sh</span>
RUN <span class="token function">chmod</span> +x /node-image/ssh.sh

<span class="token comment"># set GIT_SSH env so that npm can use to install private github repo</span>
ENV GIT_SSH<span class="token operator">=</span><span class="token string">&quot;/node-image/ssh.sh&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>其实上面的方法只是解决问题的途径之一，还有一种是通过 https 协议来安装，即在项目依赖中写死依赖的形式为:</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;somepkg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;git+https://&lt;mytoken&gt;@github.com/&lt;git-user&gt;/&lt;git-repo&gt;&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这个 <code>mytoken</code> 可以通过 <a href="https://github.com/settings/tokens" target="_blank" rel="noopener noreferrer">Personal access tokens<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来生成。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">5/13/2019, 3:05:16 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.1a92a99b.js" defer></script><script src="/assets/js/2.4bb95436.js" defer></script><script src="/assets/js/27.9b952333.js" defer></script><script src="/assets/js/9.60a9ad14.js" defer></script>
  </body>
</html>
